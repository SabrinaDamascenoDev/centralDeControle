<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles.css" />
    <title>Central de controle - NewsLetter</title>
  </head>
  <body>
    <div class="container">
      <h1 class="titulo">Central de Controle da NewsLetter</h1>
      <div class="emailContainer">
        <form action="" class="formularioDeEnvio" id="emailForm">
            <input type="text" placeholder="Assunto" class="inputForm" id="subject">
          <textarea placeholder="Digite o email para ser enviado"  id="mensagem"></textarea>
          <input type="submit" value="Enviar" class="btn"/>
        </form>

        <div class="emailsRegistrados">
          <h3 class="tituloEmails">Emails Inscritos</h3>
        </div>
      </div>
    </div>
    <script>
      
        const apiUrl = 'https://emailleadfortalsolar.onrender.com/newsletter/allClientes';
    
        // Função para buscar todos os emails
        async function fetchAllEmails() {
          try {
            // Faz a solicitação GET ao endpoint com cabeçalho Accept configurado para */*
            const response = await fetch(apiUrl, {
              headers: {
                'Accept': '*/*'
              }
            });
    
         
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
    

            const data = await response.json();
    
            // Extrai os emails da resposta
            const emails = data.map(cliente => cliente.email);
    
    
            // Atualiza o HTML com os emails
            const emailsContainer = document.querySelector('.emailsRegistrados');
            
            // Limpa os emails existentes
            emailsContainer.innerHTML = '<h3 class="tituloEmails">Emails Inscritos</h3>';
    
            // Adiciona cada email ao container
            emails.forEach(email => {
              const emailDiv = document.createElement('div');
              emailDiv.classList.add('email');
              emailDiv.innerHTML = `<p>${email}</p>`;
              emailsContainer.appendChild(emailDiv);
            });
          } catch (error) {
            console.error('Erro ao buscar emails:', error);
          }
        }
    
        // Chama a função para buscar os emails
        fetchAllEmails();
        const emailForm = document.getElementById('emailForm');
    const subjectInput = document.getElementById('subject');
    const mensagemTextarea = document.getElementById('mensagem');

    emailForm.addEventListener('submit', async (event) => {
      event.preventDefault();

      const formData = {
        subject: subjectInput.value.trim(),
        mensagem: mensagemTextarea.value.trim(),
      };


      if (!formData.subject || !formData.mensagem) {
        console.error('Assunto e mensagem são obrigatórios.');
        return;
      }

      try {
        const response = await fetch('https://emailleadfortalsolar.onrender.com/newsletter/sendEmail', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(formData),
        });


        if (response.ok) {
          console.log("Formulário enviado com sucesso!");
        } else {
          console.error("Erro ao enviar o formulário:", responseData);
        }
      } catch (error) {
        console.error("Erro de rede ou outro erro:", error);
      }
    });
  </script>
  </body>
  
</html>
